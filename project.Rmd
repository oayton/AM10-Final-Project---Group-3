---
title: "Estimation of changes in air pollution during the COVID-19 outbreak"
author: "Group 3"
date: "`r Sys.Date()`"
output:
    html_document:
      number_sections: true
      highlight: haddock
      theme: spacelab
      toc: yes
      toc_depth: 2
      toc_float:
        collapsed: false
    
---

## Background:
The lockdown response to coronavirus disease 2019 (COVID-19) has caused an unprecedented decrease in global economic and transport activity. The movement of people and the corresponding activities of production and consumption have been significantly reduced. As a possible side effect of this reduction, air pollution in many areas may have been greatly reduced. Our group aim to estimate and visualize changes in air polluton during the COVID19.

## Objectives:
* We will look at the air pollution of four cities that have all been affected by COVID-19 at different levels. 
  From our initial discussion, we have selected the following: London (United Kingdom); Wuhan (China); New Delhi (India); Auckland (New Zealand).
  In details, we will look at changes in concentrations of NOx, NO2, PM, O3, VOC, NH3.
* We will look at the changes in the community mobility of these four cities before and after COVID-19.
* We aim to comparatively explore the changes in air pollution of these cities, comparing and contrasting the levels of â€˜lockdown' measures put in place by local governments. 
* We will create informative visualisations to tell the COVID story, in addition to using ML techniques to understand the most significant factors of air pollution within the pandemic. Whilst we may have initial hypotheses, the data will speak for itself.

## Datasets:
The data we use came from [Air quality data](https://openaq.org/#/locations?_k=ggbbh8) and [COVID-19 Community Mobility Report Data](https://www.google.com/covid19/mobility/)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(tidyverse)
library(ggridges)
library(gghalves)
library(lubridate)
library(gridExtra)
library(sf)
library(vroom)
library(skimr)
library(janitor)
library(mice)
```

# STEP 1 - EXPLORATORY ANALYSIS


```{r}
# first select mobility data for our target cities
in_mob <-  vroom("2020_IN_Region_Mobility_Report.csv") %>% filter(sub_region_1=="Delhi")

gb_mob <- vroom("2020_GB_Region_Mobility_Report.csv") %>% filter(sub_region_1=="Greater London")

ch_mob <- vroom("2020_CH_Region_Mobility_Report.csv") %>% filter(sub_region_1=="Zurich")
```

```{r}
# select only past 36 months
london_air <- vroom("london-air-quality.csv") %>% 
  mutate(date = ymd(date),
         year = year(date)) %>% filter(date>=as.Date("2018-01-01"))

delhi_air <- vroom("delhi-institute of tool engineering, wazirpur, delhi, delhi, india-air-quality.csv") %>% 
  mutate(date = ymd(date),
         year = year(date)) %>% filter(date>=as.Date("2018-01-01"))

zurich_air <- vroom("zurich-kaserne, switzerland-air-quality.csv") %>% 
  mutate(date = ymd(date),
         year = year(date)) %>% filter(date>=as.Date("2018-01-01"))

```

```{r}
# describe the mobility data
skim(gb_mob)

skim(ch_mob)

skim(in_mob)
```

```{r}
# describe/view air quality data

skim(london_air)

skim(zurich_air)

skim(delhi_air)

```

```{r}
# check for dupes
london_air%>%get_dupes(date)
zurich_air %>%get_dupes(date)
delhi_air %>% get_dupes(date)

# dupes in mobility?
in_mob %>% get_dupes(date)
ch_mob %>% get_dupes(date)
gb_mob %>% get_dupes(date)

# fix duplicates across sub regions by averaging the values
in_mob_clean <- in_mob %>% group_by(date) %>% 
  summarise(retail_and_recreation_percent_change_from_baseline=mean(retail_and_recreation_percent_change_from_baseline),
                                        grocery_and_pharmacy_percent_change_from_baseline=mean(grocery_and_pharmacy_percent_change_from_baseline),
                                        parks_percent_change_from_baseline=mean(parks_percent_change_from_baseline),
                                        transit_stations_percent_change_from_baseline=mean(transit_stations_percent_change_from_baseline),
                                        workplaces_percent_change_from_baseline=mean(workplaces_percent_change_from_baseline),
                                        residential_percent_change_from_baseline=mean(residential_percent_change_from_baseline)) %>% ungroup()
gb_mob_clean <- gb_mob %>% group_by(date) %>% 
  summarise(retail_and_recreation_percent_change_from_baseline=mean(retail_and_recreation_percent_change_from_baseline),
                                        grocery_and_pharmacy_percent_change_from_baseline=mean(grocery_and_pharmacy_percent_change_from_baseline),
                                        parks_percent_change_from_baseline=mean(parks_percent_change_from_baseline),
                                        transit_stations_percent_change_from_baseline=mean(transit_stations_percent_change_from_baseline),
                                        workplaces_percent_change_from_baseline=mean(workplaces_percent_change_from_baseline),
                                        residential_percent_change_from_baseline=mean(na.omit(residential_percent_change_from_baseline))) %>% ungroup()

```

```{r}
# lets look into missing data
md.pattern(in_mob_clean,rotate.names = T)

md.pattern(gb_mob_clean,rotate.names = T)

md.pattern(ch_mob,rotate.names = T)
```

```{r}
md.pattern(delhi_air,rotate.names = T)

md.pattern(london_air,rotate.names = T)

md.pattern(zurich_air,rotate.names = T)

```


```{r}
# merge the mobility and air quality data
lon_merged <- left_join(london_air,gb_mob_clean,by='date')

del_merged <- left_join(delhi_air,in_mob_clean,by='date')

zur_merged <- left_join(zurich_air,ch_mob,by='date')
```

# Explorary Data Analysis

```{r}
# some visualizations
lon_merged %>% ggplot(aes(x=date,y=pm25,color=year)) +
  geom_smooth() +
  geom_point()

del_merged %>% ggplot(aes(x=date,y=pm25,color=year)) +
  geom_smooth() +
  geom_point()

zur_merged %>% ggplot(aes(x=date,y=pm25,color=year)) +
  geom_smooth() +
  geom_point()

```
```{r}
lon_long <- lon_merged %>% pivot_longer(cols=c(9:14),names_to="type",values_to="percent") %>% filter(date>=as.Date("2020-02-15"))
lon_long %>% ggplot(aes(x=date,y=percent,color=type)) +
  geom_smooth() +
  #geom_point() +
  NULL

del_long <- del_merged %>% pivot_longer(cols=c(9:14),names_to="type",values_to="percent") %>% filter(date>=as.Date("2020-02-15"))
del_long %>% ggplot(aes(x=date,y=percent,color=type)) +
  geom_smooth()

zur_long <- zur_merged %>% pivot_longer(cols=c(15:20),names_to="type",values_to="percent") %>% filter(date>=as.Date("2020-02-15"))
zur_long %>% ggplot(aes(x=date,y=percent,color=type)) +
  geom_smooth()

```

```{r}
# attempt one at percent change
del_pm2_averages <- del_merged %>% filter(year!=2020) %>% mutate(month=month(date),day=day(date)) %>% group_by(month,day) %>% summarise(base_pm25=mean(pm25))

del_long <- del_long %>% mutate(month=month(date),day=day(date)) %>%
  merge(.,del_pm2_averages,by=c("month","day")) %>%
  mutate(per_change_pm25=(pm25-base_pm25)/base_pm25*100)

lon_pm2_averages <- lon_merged %>% filter(year!=2020) %>% mutate(month=month(date),day=day(date)) %>% group_by(month,day) %>% summarise(base_pm25=mean(pm25))

lon_long <- lon_long %>% mutate(month=month(date),day=day(date)) %>%
  merge(.,del_pm2_averages,by=c("month","day")) %>%
  mutate(per_change_pm25=(pm25-base_pm25)/base_pm25*100)

zur_pm2_averages <- zur_merged %>% filter(year!=2020) %>%
  mutate(month=month(date),day=day(date)) %>% group_by(month,day) %>% summarise(base_pm25=mean(pm25))
zur_long <- zur_long %>% mutate(month=month(date),day=day(date)) %>%
  merge(.,del_pm2_averages,by=c("month","day")) %>%
  mutate(per_change_pm25=(pm25-base_pm25)/base_pm25*100)

```


```{r}
# attempt 2
del_merged2 <- del_merged %>% arrange(date) %>% mutate(prior_yr_pm25=lag(pm25,365),change_pm25=(pm25-prior_yr_pm25)/prior_yr_pm25*100)

lon_merged2 <- lon_merged %>% arrange(date) %>% mutate(prior_yr_pm25=lag(pm25,365),change_pm25=(pm25-prior_yr_pm25)/prior_yr_pm25*100)

zur_merged2 <- zur_merged %>% arrange(date) %>% mutate(prior_yr_pm25=lag(pm25,365),change_pm25=(pm25-prior_yr_pm25)/prior_yr_pm25*100)

```



```{r}
# plot pm2 vs workplace percent change
del_long2 <- del_merged2 %>% pivot_longer(cols=c(9:14),names_to="type",values_to="percent") %>% filter(date>=as.Date("2020-02-15"))
del_long2 %>% 
  ggplot(aes(y=change_pm25,x=percent)) +
  geom_smooth() + facet_wrap(~type,scales = "free")


lon_long2 <- lon_merged2 %>% pivot_longer(cols=c(9:14),names_to="type",values_to="percent") %>% filter(date>=as.Date("2020-02-15"))
lon_long2 %>% 
  ggplot(aes(y=change_pm25,x=percent)) +
  geom_smooth() + facet_wrap(~type,scales = "free")

zur_long2 <- zur_merged2 %>% pivot_longer(cols=c(15:20),names_to="type",values_to="percent") %>% filter(date>=as.Date("2020-02-15"))
zur_long2 %>% 
  ggplot(aes(y=change_pm25,x=percent)) +
  geom_smooth() + facet_wrap(~type,scales = "free")


```


```{r lm}
#zurich
m1 <- zur_merged %>% mutate(month=month(date)) %>% 
  lm(pm25 ~ retail_and_recreation_percent_change_from_baseline+
     grocery_and_pharmacy_percent_change_from_baseline+
     transit_stations_percent_change_from_baseline+
     parks_percent_change_from_baseline+
     workplaces_percent_change_from_baseline+
     residential_percent_change_from_baseline+
       month,na.action=na.omit,data=.)

summary(m1)

#london
m2 <- lon_merged %>% mutate(month=month(date)) %>% 
  lm(pm25 ~ retail_and_recreation_percent_change_from_baseline+
     grocery_and_pharmacy_percent_change_from_baseline+
     transit_stations_percent_change_from_baseline+
     parks_percent_change_from_baseline+
     workplaces_percent_change_from_baseline+
     residential_percent_change_from_baseline+
       month,na.action=na.omit,data=.)

summary(m2)

#delhi
m3 <- lon_merged %>% mutate(month=month(date)) %>% 
  lm(pm25 ~ retail_and_recreation_percent_change_from_baseline+
     grocery_and_pharmacy_percent_change_from_baseline+
     transit_stations_percent_change_from_baseline+
     parks_percent_change_from_baseline+
     workplaces_percent_change_from_baseline+
     residential_percent_change_from_baseline+
       month,na.action=na.omit,data=.)

summary(m3)

```

```{r tree}
#maybe try with log prices
library(caret)
library(rpart.plot)


# delhi
set.seed(1234)
control <- trainControl (
    method="cv",
    number=5,
    verboseIter=TRUE)
merged_nona <- del_merged %>% mutate(month=month(date))
tree_delhi <- train(
  pm25 ~ retail_and_recreation_percent_change_from_baseline+
     grocery_and_pharmacy_percent_change_from_baseline+
     transit_stations_percent_change_from_baseline+
     parks_percent_change_from_baseline+
     workplaces_percent_change_from_baseline+
     residential_percent_change_from_baseline+
    month,
  merged_nona,
  method = "rpart",
  na.action = na.omit,
  trControl = control,
  tuneLength=10
    )

#You can view how the tree performs
tree_delhi$results

#You can view the final tree
rpart.plot(tree_delhi$finalModel)

#you can also visualize the variable importance
importance <- varImp(tree_delhi, scale=TRUE)
plot(importance)

```

```{r}

# london
set.seed(1234)
control <- trainControl (
    method="cv",
    number=5,
    verboseIter=TRUE)
merged_nona <- lon_merged %>% mutate(month=month(date))
md.pattern(merged_nona,rotate.names = T)

tree_lon <- train(
  pm25 ~ retail_and_recreation_percent_change_from_baseline+
     grocery_and_pharmacy_percent_change_from_baseline+
     transit_stations_percent_change_from_baseline+
     parks_percent_change_from_baseline+  
     workplaces_percent_change_from_baseline+
     month+
     residential_percent_change_from_baseline
  ,
  merged_nona,
  method = "rpart",
  na.action = na.omit,
  trControl = control,
  tuneLength=10
    )

#You can view how the tree performs
tree_lon$results

#You can view the final tree
rpart.plot(tree_lon$finalModel)

#you can also visualize the variable importance
importance <- varImp(tree_lon, scale=TRUE)
plot(importance)


```

```{r}
# zurich
set.seed(1234)
control <- trainControl (
    method="cv",
    number=5,
    verboseIter=TRUE)
merged_nona <- zur_merged %>% mutate(month=month(date))
tree_zur <- train(
  pm25 ~ retail_and_recreation_percent_change_from_baseline+
     grocery_and_pharmacy_percent_change_from_baseline+
     transit_stations_percent_change_from_baseline+
     parks_percent_change_from_baseline+
     workplaces_percent_change_from_baseline+
     residential_percent_change_from_baseline+
    month,
  merged_nona,
  method = "rpart",
  na.action = na.omit,
  trControl = control,
  tuneLength=10
    )

#You can view how the tree performs
tree_zur$results

#You can view the final tree
rpart.plot(tree_zur$finalModel)

#you can also visualize the variable importance
importance <- varImp(tree_zur, scale=TRUE)
plot(importance)


```
```{r}
train_control <- trainControl (
    method="cv",
    number=5,
    verboseIter=TRUE)

library(GGally)
merged_nona %>% ggcorr(layout.position="left")
set.seed(1234)
# Fit random forest: model
merged_nona <- del_merged %>% mutate(month=month(date))
rf_RF <- train(
   no2 ~ retail_and_recreation_percent_change_from_baseline+
     grocery_and_pharmacy_percent_change_from_baseline+
     transit_stations_percent_change_from_baseline+
     retail_and_recreation_percent_change_from_baseline+
     workplaces_percent_change_from_baseline+
     residential_percent_change_from_baseline+
    month,
  merged_nona, 
  method = "ranger",
  na.action = na.omit,
   #metric="ROC",
  trControl = train_control,
  importance = 'permutation',
  tuneLength=10
)

rf_RF$results

rf_RF$bestTune

importance <- varImp(rf_RF, scale=TRUE)
importance
varImps <- importance$importance %>% rownames_to_column()
varImps %>% ggplot(aes(x=reorder(rowname,-Overall),y=Overall)) +
  geom_col() +
  scale_x_discrete(labels=c("Retail & Recreation","Month","Workplaces",
                            "Residential","Grocery & Pharmacy","Transit Stations"))+
  theme_minimal() +
  labs(title="Delhi: Which Factors Effect PM25 The Most?",y="Feature Importance",x="Category")
```



```{r rf}
train_control <- trainControl (
    method="cv",
    number=5,
    verboseIter=TRUE)

merged_nona %>% ggcorr(layout.position="left")
set.seed(1234)
# Fit random forest: model
merged_nona <- lon_merged %>% mutate(month=month(date))
rf_RF <- train(
   no2 ~ retail_and_recreation_percent_change_from_baseline+
     grocery_and_pharmacy_percent_change_from_baseline+
     transit_stations_percent_change_from_baseline+
     retail_and_recreation_percent_change_from_baseline+
     workplaces_percent_change_from_baseline+
     residential_percent_change_from_baseline+
    month,
  merged_nona, 
  method = "ranger",
  na.action = na.omit,
   #metric="ROC",
  trControl = train_control,
  importance = 'permutation',
  tuneLength=10
)

rf_RF$results

rf_RF$bestTune

importance <- varImp(rf_RF, scale=TRUE)
importance
varImps <- importance$importance %>% rownames_to_column()
varImps %>% ggplot(aes(x=reorder(rowname,-Overall),y=Overall)) +
  geom_col() +
  scale_x_discrete(labels=c("Retail & Recreation","Month","Workplaces",
                            "Residential","Grocery & Pharmacy","Transit Stations"))+
  theme_minimal() +
  labs(title="London: Which Factors Effect PM25 The Most?",y="Weight",x="Category")
```
```{r}
set.seed(1234)
# Fit random forest: model

merged_nona %>% ggcorr(layout.position="left")
merged_nona <- zur_merged %>% mutate(month=month(date))
rf_RF <- train(
   no2 ~ retail_and_recreation_percent_change_from_baseline+
     grocery_and_pharmacy_percent_change_from_baseline+
     transit_stations_percent_change_from_baseline+
     retail_and_recreation_percent_change_from_baseline+
     workplaces_percent_change_from_baseline+
     residential_percent_change_from_baseline+
    month,
  merged_nona, 
  method = "ranger",
  na.action = na.omit,
   #metric="ROC",
  trControl = train_control,
  importance = 'permutation',
  tuneLength=10
)

rf_RF$results

rf_RF$bestTune

importance <- varImp(rf_RF, scale=TRUE)
plot(importance)
```



